#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
VICE Emulator Detection and Management System
WinVICE/VICE em√ºlat√∂r√ºn√º otomatik tespit eden ve kurulan sistemi y√∂neten mod√ºl

Features:
- Otomatik VICE em√ºlat√∂r tespit
- Sistem yollarƒ±nda arama
- Registry kontrol√º (Windows)
- Kurulum doƒürulama
- Petcat yolu tespiti
- C1541 yolu tespiti
"""

import os
import sys
import subprocess
import platform
import shutil
from pathlib import Path
from typing import Optional, List, Dict, Tuple
import winreg
import logging

# Logging ayarlarƒ±
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

class VICEDetector:
    """VICE Em√ºlat√∂r Tespit ve Y√∂netim Sistemi"""
    
    def __init__(self):
        self.system = platform.system().lower()
        self.vice_info = {
            'detected': False,
            'version': None,
            'path': None,
            'petcat_path': None,
            'c1541_path': None,
            'x64_path': None,
            'tools_available': []
        }
        
        # Olasƒ± VICE kurulum yollarƒ±
        self.common_paths = self._get_common_paths()
        
    def _get_common_paths(self) -> List[str]:
        """Sistemdeki olasƒ± VICE kurulum yollarƒ±"""
        paths = []
        
        if self.system == 'windows':
            # Windows ortak kurulum yollarƒ±
            drive_letters = ['C:', 'D:', 'E:', 'F:']
            base_paths = [
                r'\Program Files\WinVICE-3.8-x64',
                r'\Program Files\WinVICE-3.7-x64', 
                r'\Program Files\WinVICE-3.6-x64',
                r'\Program Files\WinVICE',
                r'\Program Files (x86)\WinVICE-3.8-x64',
                r'\Program Files (x86)\WinVICE-3.7-x64',
                r'\Program Files (x86)\WinVICE-3.6-x64',
                r'\Program Files (x86)\WinVICE',
                r'\vice',
                r'\tools\vice',
                r'\emulators\vice',
                r'\c64\vice'
            ]
            
            for drive in drive_letters:
                for base_path in base_paths:
                    full_path = drive + base_path
                    if os.path.exists(full_path):
                        paths.append(full_path)
                        
        elif self.system == 'linux':
            # Linux ortak kurulum yollarƒ±
            paths = [
                '/usr/bin',
                '/usr/local/bin', 
                '/opt/vice',
                '/usr/share/vice',
                '/home/' + os.getenv('USER', '') + '/.local/bin'
            ]
            
        elif self.system == 'darwin':
            # macOS ortak kurulum yollarƒ±
            paths = [
                '/Applications/VICE',
                '/usr/local/bin',
                '/opt/homebrew/bin'
            ]
            
        return paths
        
    def detect_vice(self) -> bool:
        """VICE em√ºlat√∂r√ºn√º tespit et"""
        logger.info("üîç VICE em√ºlat√∂r tespiti ba≈ülatƒ±lƒ±yor...")
        
        # 1. Sistem PATH'inde ara
        if self._check_system_path():
            return True
            
        # 2. Registry'de ara (Windows)
        if self.system == 'windows' and self._check_windows_registry():
            return True
            
        # 3. Ortak kurulum yollarƒ±nda ara
        if self._check_common_paths():
            return True
            
        # 4. Manuel arama
        if self._manual_search():
            return True
            
        logger.warning("‚ö†Ô∏è VICE em√ºlat√∂r√º bulunamadƒ±!")
        return False
        
    def _check_system_path(self) -> bool:
        """Sistem PATH'inde VICE ara√ßlarƒ±nƒ± kontrol et"""
        tools = ['petcat', 'c1541', 'x64']
        
        for tool in tools:
            if self.system == 'windows':
                tool += '.exe'
                
            path = shutil.which(tool)
            if path:
                logger.info(f"‚úÖ {tool} bulundu: {path}")
                self.vice_info[f'{tool.replace(".exe", "")}_path'] = path
                self.vice_info['tools_available'].append(tool.replace('.exe', ''))
                
                if not self.vice_info['path']:
                    # ƒ∞lk bulunan aracƒ±n dizinini ana yol olarak kullan
                    self.vice_info['path'] = os.path.dirname(path)
                    
        if self.vice_info['tools_available']:
            self.vice_info['detected'] = True
            logger.info(f"‚úÖ VICE PATH'de tespit edildi: {self.vice_info['path']}")
            return True
            
        return False
        
    def _check_windows_registry(self) -> bool:
        """Windows Registry'de VICE kurulumunu kontrol et"""
        if self.system != 'windows':
            return False
            
        registry_keys = [
            r"SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall",
            r"SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall"
        ]
        
        try:
            for reg_key in registry_keys:
                with winreg.OpenKey(winreg.HKEY_LOCAL_MACHINE, reg_key) as key:
                    for i in range(winreg.QueryInfoKey(key)[0]):
                        subkey_name = winreg.EnumKey(key, i)
                        if 'vice' in subkey_name.lower() or 'winvice' in subkey_name.lower():
                            try:
                                with winreg.OpenKey(key, subkey_name) as subkey:
                                    install_location = winreg.QueryValueEx(subkey, "InstallLocation")[0]
                                    if os.path.exists(install_location):
                                        self.vice_info['path'] = install_location
                                        self.vice_info['detected'] = True
                                        self._detect_tools_in_path(install_location)
                                        logger.info(f"‚úÖ VICE Registry'de bulundu: {install_location}")
                                        return True
                            except:
                                continue
                                
        except Exception as e:
            logger.debug(f"Registry okuma hatasƒ±: {e}")
            
        return False
        
    def _check_common_paths(self) -> bool:
        """Ortak kurulum yollarƒ±nda VICE'ƒ± ara"""
        for path in self.common_paths:
            if os.path.exists(path):
                logger.info(f"üîç Kontrol ediliyor: {path}")
                if self._detect_tools_in_path(path):
                    self.vice_info['path'] = path
                    self.vice_info['detected'] = True
                    logger.info(f"‚úÖ VICE bulundu: {path}")
                    return True
                    
        return False
        
    def _manual_search(self) -> bool:
        """Manuel arama - kullanƒ±cƒ± bilinen yollarƒ± kontrol etsin"""
        logger.info("üîç Manuel arama ba≈ülatƒ±lƒ±yor...")
        
        # Kullanƒ±cƒ±dan VICE yolu isteme
        print("\n" + "="*60)
        print("üéÆ VICE EM√úLAT√ñR TESPƒ∞T Sƒ∞STEMƒ∞")
        print("="*60)
        print("VICE em√ºlat√∂r√º otomatik olarak bulunamadƒ±.")
        print("L√ºtfen VICE kurulum dizinini manuel olarak belirtin.")
        print("\n√ñrnek yollar:")
        print("  Windows: C:\\Program Files\\WinVICE-3.8-x64")
        print("  Linux:   /usr/bin")
        print("  macOS:   /Applications/VICE")
        print("\nBo≈ü bƒ±rakƒ±p Enter'a basarsanƒ±z tespit atlanƒ±r.")
        
        user_path = input("\nVICE kurulum dizini: ").strip()
        
        if user_path and os.path.exists(user_path):
            if self._detect_tools_in_path(user_path):
                self.vice_info['path'] = user_path
                self.vice_info['detected'] = True
                logger.info(f"‚úÖ Manuel VICE yolu kabul edildi: {user_path}")
                return True
            else:
                logger.warning(f"‚ö†Ô∏è Bu dizinde VICE ara√ßlarƒ± bulunamadƒ±: {user_path}")
                
        return False
        
    def _detect_tools_in_path(self, base_path: str) -> bool:
        """Belirtilen dizinde VICE ara√ßlarƒ±nƒ± tespit et"""
        tools = ['petcat', 'c1541', 'x64']
        found_tools = []
        
        # Alt dizinleri de kontrol et
        search_dirs = [base_path]
        for subdir in ['bin', 'tools', '.']:
            full_subdir = os.path.join(base_path, subdir)
            if os.path.exists(full_subdir):
                search_dirs.append(full_subdir)
                
        for search_dir in search_dirs:
            for tool in tools:
                tool_paths = [
                    os.path.join(search_dir, tool),
                    os.path.join(search_dir, tool + '.exe')
                ]
                
                for tool_path in tool_paths:
                    if os.path.exists(tool_path) and os.path.isfile(tool_path):
                        self.vice_info[f'{tool}_path'] = tool_path
                        found_tools.append(tool)
                        logger.info(f"  ‚úÖ {tool} bulundu: {tool_path}")
                        break
                        
        self.vice_info['tools_available'] = found_tools
        return len(found_tools) > 0
        
    def get_vice_version(self) -> Optional[str]:
        """VICE s√ºr√ºm√ºn√º tespit et"""
        if not self.vice_info['detected']:
            return None
            
        # x64 ile s√ºr√ºm tespiti
        x64_path = self.vice_info.get('x64_path')
        if x64_path:
            try:
                result = subprocess.run([x64_path, '--version'], 
                                      capture_output=True, text=True, timeout=10)
                if result.returncode == 0:
                    version_line = result.stdout.split('\n')[0]
                    self.vice_info['version'] = version_line
                    return version_line
            except:
                pass
                
        # petcat ile s√ºr√ºm tespiti
        petcat_path = self.vice_info.get('petcat_path')
        if petcat_path:
            try:
                result = subprocess.run([petcat_path, '-h'], 
                                      capture_output=True, text=True, timeout=10)
                if result.returncode == 0 or result.stderr:
                    output = result.stderr or result.stdout
                    for line in output.split('\n'):
                        if 'petcat' in line.lower() and ('vice' in line.lower() or 'version' in line.lower()):
                            self.vice_info['version'] = line.strip()
                            return line.strip()
            except:
                pass
                
        return "S√ºr√ºm tespit edilemedi"
        
    def validate_installation(self) -> Dict[str, bool]:
        """VICE kurulumunu doƒürula"""
        validation = {
            'petcat': False,
            'c1541': False, 
            'x64': False,
            'overall': False
        }
        
        if not self.vice_info['detected']:
            return validation
            
        # Her aracƒ± test et
        for tool in ['petcat', 'c1541', 'x64']:
            tool_path = self.vice_info.get(f'{tool}_path')
            if tool_path and os.path.exists(tool_path):
                try:
                    # Kƒ±sa test komutu
                    test_args = {
                        'petcat': ['-h'],
                        'c1541': ['-h'], 
                        'x64': ['--help']
                    }
                    
                    result = subprocess.run([tool_path] + test_args[tool],
                                          capture_output=True, timeout=5)
                    validation[tool] = result.returncode in [0, 1]  # 0 veya 1 kabul edilebilir
                    
                except Exception as e:
                    logger.debug(f"{tool} test hatasƒ±: {e}")
                    validation[tool] = False
                    
        # Genel doƒürulama - en az petcat ve c1541 √ßalƒ±≈ümalƒ±
        validation['overall'] = validation['petcat'] and validation['c1541']
        
        return validation
        
    def get_report(self) -> str:
        """VICE tespit raporu olu≈ütur"""
        lines = [
            "üéÆ VICE EM√úLAT√ñR TESPƒ∞T RAPORU",
            "=" * 50
        ]
        
        if self.vice_info['detected']:
            lines.extend([
                f"‚úÖ Durum: VICE Tespit Edildi",
                f"üìÇ Ana Dizin: {self.vice_info['path']}",
                f"üìÑ S√ºr√ºm: {self.get_vice_version() or 'Bilinmiyor'}",
                "",
                "üîß Tespit Edilen Ara√ßlar:"
            ])
            
            for tool in ['petcat', 'c1541', 'x64']:
                tool_path = self.vice_info.get(f'{tool}_path')
                if tool_path:
                    lines.append(f"  ‚úÖ {tool}: {tool_path}")
                else:
                    lines.append(f"  ‚ùå {tool}: Bulunamadƒ±")
                    
            # Doƒürulama sonu√ßlarƒ±
            validation = self.validate_installation()
            lines.extend([
                "",
                "üß™ Ara√ß Doƒürulama Testleri:"
            ])
            
            for tool, status in validation.items():
                if tool != 'overall':
                    icon = "‚úÖ" if status else "‚ùå"
                    lines.append(f"  {icon} {tool}: {'√áalƒ±≈üƒ±yor' if status else 'Hata'}")
                    
            overall_status = "‚úÖ Hazƒ±r" if validation['overall'] else "‚ùå Sorunlu"
            lines.append(f"\nüéØ Genel Durum: {overall_status}")
            
        else:
            lines.extend([
                "‚ùå Durum: VICE Tespit Edilemedi",
                "",
                "üí° √ñneriler:",
                "  1. VICE em√ºlat√∂r√ºn√º indirin: https://vice-emu.sourceforge.io/",
                "  2. Program Files dizinine kurun",
                "  3. PATH √ßevre deƒüi≈ükenine ekleyin",
                "  4. Bu programƒ± yeniden √ßalƒ±≈ütƒ±rƒ±n"
            ])
            
        return "\n".join(lines)
        
    def install_vice_guide(self) -> str:
        """VICE kurulum rehberi"""
        guide = """
üéÆ VICE EM√úLAT√ñR KURULUM REHBERƒ∞
================================

1. VICE ƒ∞NDƒ∞RME:
   - https://vice-emu.sourceforge.io/ adresine gidin
   - Windows i√ßin "WinVICE" b√∂l√ºm√ºnden g√ºncel s√ºr√ºm√º indirin
   - √ñnerilen: WinVICE-3.8-x64-r44730.7z

2. KURULUM:
   - ƒ∞ndirilen ar≈üivi a√ßƒ±n
   - √áƒ±kan dizini C:\\Program Files\\ altƒ±na kopyalayƒ±n
   - √ñrnek: C:\\Program Files\\WinVICE-3.8-x64\\

3. PATH AYARLAMA (ƒ∞steƒüe baƒülƒ±):
   - Ba≈ülat > "environ" arayƒ±n
   - "Sistem √ßevre deƒüi≈ükenlerini d√ºzenle" a√ßƒ±n
   - "√áevre Deƒüi≈ükenleri" butonuna tƒ±klayƒ±n
   - PATH'e VICE bin dizinini ekleyin

4. TEST:
   - Bu programƒ± yeniden √ßalƒ±≈ütƒ±rƒ±n
   - VICE otomatik tespit edilmelidir

üîß PETCAT KULLANIMI:
   - BASIC programlarƒ± i√ßin: petcat -2 program.prg
   - Assembly i√ßin: petcat -a program.prg
"""
        return guide

# Test fonksiyonu
if __name__ == "__main__":
    print("üß™ VICE Detector Test")
    print("=" * 30)
    
    detector = VICEDetector()
    
    print("\nüîç VICE tespiti ba≈ülatƒ±lƒ±yor...")
    success = detector.detect_vice()
    
    print("\n" + detector.get_report())
    
    if not success:
        print("\n" + detector.install_vice_guide())
